# Week 12 评分标准：集成测试与 Bug Bash

## 总分：100 分（基础 100 分 + 进阶 20 分）

---

## 评分维度

| 维度 | 分值 | 评分标准 | 验证方式 |
|------|------|---------|---------|
| **API 集成测试** | 40 | 编写至少 3 个 API 集成测试，覆盖正常、边界、异常场景 | 检查 TaskApiIntegrationTest.java + 测试运行结果 |
| **Mock 测试** | 30 | 使用 Mockito 编写至少 2 个 Mock 测试，验证方法调用 | 检查 TaskServiceMockTest.java + 测试运行结果 |
| **Bug Bash 参与** | 30 | 参与 Bug Bash，提交报告，完成根因分析 | 检查 BUG_BASH_REPORT.md + ROOT_CAUSE_ANALYSIS.md |

---

## 详细评分标准

### 1. API 集成测试（40 分）

| 等级 | 分值 | 标准 |
|------|------|------|
| 优秀 | 36-40 | 5+ 个集成测试，覆盖正常/边界/异常场景，使用 HttpClient，验证 HTTP 状态码和 JSON 响应，契约测试完整 |
| 良好 | 30-35 | 4 个集成测试，覆盖主要场景，验证响应正确 |
| 合格 | 24-29 | 3 个集成测试，基本覆盖，验证基本正确 |
| 不合格 | 0-23 | 测试少于 3 个或无法运行 |

#### 1.1 测试类配置（5 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| @BeforeEach/@AfterEach | 2 | 正确配置测试环境启动和关闭 |
| Javalin 服务器启动 | 2 | 集成测试启动真实服务 |
| 测试数据隔离 | 1 | 每个测试独立，不互相影响 |

**检查要点**：
- [ ] `@BeforeEach` 启动 Javalin 服务器（2 分）
- [ ] `@AfterEach` 关闭服务器（1 分）
- [ ] 使用内存数据库或清理测试数据（2 分）

**常见错误**：
- 忘记关闭服务器，导致端口占用
- 测试之间数据未清理，互相影响
- 硬编码端口 8080，导致并发测试失败

#### 1.2 GET /api/tasks 测试（10 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 空列表测试 | 4 | 初始状态返回空列表 [] |
| 有数据测试 | 4 | 返回包含任务的 JSON 数组 |
| HTTP 状态码验证 | 2 | 验证 200 OK |

**检查要点**：
- [ ] 使用 `HttpClient.newHttpClient()` 发送请求（3 分）
- [ ] 验证 `response.statusCode() == 200`（3 分）
- [ ] 验证 `response.body()` 包含预期 JSON（4 分）

**常见错误**：
- 忘记设置请求头（如 `Content-Type`）
- 验证不完整（只验证状态码，不验证响应体）
- 字符串比较错误（如 JSON 格式问题）

#### 1.3 POST /api/tasks 测试（10 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 请求体构造 | 3 | 正确构造 JSON 请求体 |
| HTTP 状态码验证 | 3 | 验证 201 Created |
| 响应体验证 | 4 | 验证返回的任务 JSON |

**检查要点**：
- [ ] 使用 `BodyPublishers.ofString(jsonBody)`（3 分）
- [ ] 设置 `Content-Type: application/json`（2 分）
- [ ] 验证 201 状态码（3 分）
- [ ] 验证响应体包含创建的任务（2 分）

**常见错误**：
- 忘记设置 `Content-Type` 头
- 状态码验证错误（如验证 200 而不是 201）
- JSON 字段名不匹配（如 `taskName` vs `title`）

#### 1.4 错误场景测试（10 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 404 Not Found | 4 | GET 不存在的资源返回 404 |
| 400 Bad Request | 4 | POST 无效数据返回 400 |
| 错误响应格式 | 2 | 验证错误响应包含错误信息 |

**检查要点**：
- [ ] 测试 GET /api/tasks/999 返回 404（4 分）
- [ ] 测试 POST 空标题返回 400（4 分）
- [ ] 验证错误响应包含错误描述（2 分）

**常见错误**：
- 只测试正常流程，遗漏错误场景
- 错误状态码验证错误（如 500 而不是 404）
- 错误响应未验证

#### 1.5 契约测试（5 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 字段名验证 | 3 | 验证 JSON 字段名（如 title, completed） |
| 类型验证 | 2 | 验证字段类型（如 id 是字符串，completed 是布尔） |

**检查要点**：
- [ ] 验证 JSON 包含预期字段（3 分）
- [ ] 验证字段名正确（不是 taskName）（2 分）

---

### 2. Mock 测试（30 分）

| 等级 | 分值 | 标准 |
|------|------|------|
| 优秀 | 26-30 | 3+ 个 Mock 测试，使用 @Mock/@InjectMocks，验证方法调用，包含 Spy 测试 |
| 良好 | 20-25 | 2 个 Mock 测试，正确使用 Mockito |
| 合格 | 15-19 | 1 个 Mock 测试，基本使用正确 |
| 不合格 | 0-14 | Mock 测试无效或无法运行 |

#### 2.1 Mockito 配置（5 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 依赖配置 | 3 | pom.xml 正确添加 Mockito 依赖 |
| 注解使用 | 2 | 使用 @ExtendWith(MockitoExtension.class) |

**检查要点**：
- [ ] pom.xml 包含 mockito-core 和 mockito-junit-jupiter（3 分）
- [ ] 版本号正确（5.12.0 或相近版本）（1 分）
- [ ] 测试类使用 `@ExtendWith(MockitoExtension.class)`（1 分）

**常见配置错误**：
- 缺少 mockito-junit-jupiter 依赖
- 版本号过时或不存在
- 忘记添加 @ExtendWith 注解

#### 2.2 Mock 测试实现（15 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| @Mock/@InjectMocks | 4 | 正确使用 Mockito 注解 |
| when/thenReturn | 5 | 预设 Mock 返回值 |
| verify 验证 | 4 | 验证方法调用 |
| 断言正确 | 2 | 测试断言正确 |

**单个 Mock 测试评分标准**（每个 5 分）：
- [ ] 使用 `@Mock` 创建 Mock 对象（1 分）
- [ ] 使用 `when(mock.method()).thenReturn()` 预设返回（2 分）
- [ ] 使用 `verify(mock).method()` 验证调用（1 分）
- [ ] 断言结果正确（1 分）

**检查要点**：
- [ ] 至少 2 个 Mock 测试方法（8 分）
- [ ] Mock Repository 层，测试 Service 层（4 分）
- [ ] 验证方法调用次数（verify + times）（3 分）

**常见错误**：
- Mock 了被测试的类（应该 Mock 依赖）
- 忘记使用 `when().thenReturn()` 预设返回值
- 忘记验证方法调用（verify）
- 过度 Mock（测试了 Mock 而非真实逻辑）

#### 2.3 Spy 测试（10 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| spy() 创建 | 3 | 使用 spy() 创建部分 Mock 对象 |
| 真实方法调用 | 4 | 调用真实方法并验证行为 |
| 验证调用 | 3 | 使用 verify 验证调用次数 |

**检查要点**：
- [ ] 使用 `spy(object)` 创建 Spy 对象（3 分）
- [ ] 调用真实方法（如 `task.markCompleted()`）（4 分）
- [ ] 验证方法被调用（3 分）

**常见错误**：
- 使用 `mock()` 而不是 `spy()`
- 忘记 Spy 对象的方法是真实调用的
- 过度使用 Spy（应该优先使用 Mock）

---

### 3. Bug Bash 参与与报告（30 分）

| 等级 | 分值 | 标准 |
|------|------|------|
| 优秀 | 26-30 | 参与 Bug Bash，发现 3+ 个 bug，报告完整，根因分析深入，修复有效 |
| 良好 | 20-25 | 参与 Bug Bash，发现 2 个 bug，报告基本完整，有根因分析 |
| 合格 | 15-19 | 参与 Bug Bash，发现 1 个 bug，报告基本完整 |
| 不合格 | 0-14 | 未参与或报告不完整 |

#### 3.1 Bug Bash 参与（5 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 参与活动 | 3 | 参与团队 Bug Bash 活动 |
| 测试其他系统 | 2 | 测试至少 1 个其他团队的系统 |

**检查要点**：
- [ ] Bug Bash 报告记录了测试时间、测试对象（3 分）
- [ ] 记录了其他团队的反馈（2 分）

#### 3.2 Bug Bash 报告（10 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 问题数量 | 4 | 发现至少 2 个 bug |
| 复现步骤 | 3 | 每个 bug 包含清晰的复现步骤 |
| 优先级分类 | 2 | 正确标注 P0/P1/P2/P3 |
| 修复计划 | 1 | 有明确的修复计划 |

**Bug 数量评分**：
- 3+ 个 bug：+1 分
- 2 个 bug：4 分
- 1 个 bug：2 分
- 0 个 bug：0 分

**单个 Bug 记录评分**（每个 3 分）：
- [ ] 问题描述清晰（1 分）
- [ ] 复现步骤完整（1 分）
- [ ] 优先级标注正确（1 分）

**检查要点**：
- [ ] BUG_BASH_REPORT.md 包含测试环境信息（2 分）
- [ ] 至少 2 个 bug 记录（4 分）
- [ ] 每个 bug 包含：ID、描述、复现步骤、优先级（4 分）

**常见问题**：
- 复现步骤不清晰（如"操作一下就出 bug"）
- 优先级混乱（如将样式问题标为 P0）
- 缺少修复计划

#### 3.3 根因分析（15 分）

| 评分项 | 分值 | 评分标准 |
|--------|------|---------|
| 直接原因 | 3 | 说明 bug 的直接原因 |
| 设计缺陷分析 | 4 | 分析是设计问题还是实现问题 |
| 测试盲区分析 | 4 | 解释为什么测试没发现 |
| 修复方案完整性 | 4 | 包含预防措施，不只是修复表面 |

**根因分析评分**（每个 15 分）：
- [ ] **直接原因**（3 分）：说明 bug 的直接原因（如数据库字符集问题）
- [ ] **设计缺陷**（4 分）：是设计问题还是实现问题？
- [ ] **测试盲区**（4 分）：为什么测试没发现？（如只测试了 ASCII 字符）
- [ ] **修复方案**（4 分）：包含预防措施（如添加输入验证、补充测试）

**检查要点**：
- [ ] ROOT_CAUSE_ANALYSIS.md 包含至少 1 个 bug 的详细分析（10 分）
- [ ] 包含"直接原因"（3 分）
- [ ] 包含"设计缺陷"（4 分）
- [ ] 包含"测试盲区"（4 分）
- [ ] 包含"修复方案"（4 分）

**常见问题**：
- 只说"代码写错了"，没有分析设计缺陷
- 没有解释为什么测试没发现
- 修复方案只改代码，没有预防措施

**优秀根因分析示例**：
```markdown
## Bug #1: Emoji 导致 500 错误

### 直接原因
数据库字符集未设置为 UTF-8，无法存储 emoji 字符

### 设计缺陷
- 数据库初始化时未指定字符集
- 缺少输入验证（标题长度、字符类型）
- 错误处理不完善（500 而不是 400）

### 测试盲区
- 单元测试只测试了 ASCII 字符
- 集成测试未包含边界数据（emoji、超长字符串）
- 缺少异常场景测试

### 修复方案
1. 修改数据库连接字符串，指定 UTF-8 字符集
2. 添加输入验证：标题长度限制 100 字符
3. 添加全局异常处理，返回友好的错误信息
4. 补充测试：包含 emoji、超长字符串的测试用例
```

---

## 进阶作业评分（+20 分）

### 进阶 1：契约测试与 OpenAPI（+10 分）

| 项目 | 分值 | 评分标准 |
|------|------|---------|
| OpenAPI 规范 | 5 | openapi.yaml 包含完整的 API 描述（路径、方法、请求体、响应体） |
| 契约测试 | 5 | ContractTest.java 验证 API 符合 OpenAPI 规范 |

**检查要点**：
- [ ] openapi.yaml 格式正确（2 分）
- [ ] 包含至少 2 个端点的定义（2 分）
- [ ] 契约测试验证字段名和类型（1 分）

---

### 进阶 2：E2E 测试（+10 分）

| 项目 | 分值 | 评分标准 |
|------|------|---------|
| E2E 测试实现 | 6 | TaskE2ETest.java 包含至少 1 个端到端测试 |
| 测试有效性 | 4 | 测试模拟真实用户操作，验证完整流程 |

**检查要点**：
- [ ] 使用浏览器自动化工具（2 分）
- [ ] 测试模拟真实用户操作（2 分）
- [ ] 验证完整流程（2 分）
- [ ] 测试能独立运行（2 分）

---

## 等级划分

| 等级 | 分数范围 | 描述 |
|------|---------|------|
| **A** | 90-100 | 集成测试 5+，Mock 测试 3+，Bug Bash 发现 3+ bug，根因分析深入 |
| **B** | 80-89 | 集成测试 4，Mock 测试 2，Bug Bash 发现 2 bug，有根因分析 |
| **C** | 70-79 | 集成测试 3，Mock 测试 2，Bug Bash 发现 1 bug，根因分析基本完整 |
| **D** | 60-69 | 集成测试 3，Mock 测试 1，参与 Bug Bash，报告基本完整 |
| **F** | <60 | 未完成或严重不符合要求 |

---

## 迟交政策

| 迟交时间 | 扣分 |
|---------|------|
| 24 小时内 | -10% |
| 48 小时内 | -20% |
| 超过 48 小时 | 按 0 分计 |

---

## 学术诚信

- **允许**：使用 AI 辅助生成测试代码、参考公开文档、使用 IDE 提示
- **禁止**：
  - 复制其他同学的测试代码
  - 编造虚假的 Bug Bash 报告
  - 根因分析只是复制 bug 描述，没有深入分析

**AI 使用透明化**：如果使用 AI 辅助生成测试，需在 AI_LOG.md 中记录使用的 Prompt 和 AI 输出，以及你的审查发现。

---

## 评分检查清单（助教使用）

### 文件完整性检查
- [ ] TaskApiIntegrationTest.java 存在
- [ ] integration_test_results.txt 存在
- [ ] pom.xml 包含 Mockito 依赖
- [ ] TaskServiceMockTest.java 存在
- [ ] BUG_BASH_REPORT.md 存在且包含至少 2 个 bug
- [ ] ROOT_CAUSE_ANALYSIS.md 存在且包含详细分析

### 功能验证
- [ ] `mvn test` 通过（所有测试）
- [ ] 集成测试使用 HttpClient
- [ ] Mock 测试使用 Mockito
- [ ] Bug Bash 报告包含复现步骤

### 代码审查
- [ ] 集成测试启动真实服务
- [ ] Mock 测试验证方法调用
- [ ] 根因分析不只修复表面问题

---

## 反馈模板

### 优秀作业反馈示例
```
总分：94/100（A）

亮点：
- 集成测试覆盖完整，包含正常、边界、异常场景
- 使用 HttpClient 发送真实 HTTP 请求，验证状态码和响应体
- Mock 测试正确使用 @Mock/@InjectMocks，验证方法调用
- Bug Bash 报告详细，包含 3 个 bug，复现步骤清晰
- 根因分析深入，不只是修复代码，还分析了设计缺陷和测试盲区

建议：
- 可以考虑为 E2E 测试添加更多用户场景
- Bug Bash 报告可以添加截图，更直观展示问题
```

### 需改进作业反馈示例
```
总分：65/100（D）

问题：
- 集成测试只有 2 个，遗漏了错误场景（如 404、400）（-10 分）
- Mock 测试忘记使用 verify 验证方法调用（-8 分）
- Bug Bash 报告只有 1 个 bug，且复现步骤不清晰（-10 分）
- 根因分析过于简单，只说"代码写错了"，没有分析设计缺陷（-7 分）

改进建议：
1. 补充错误场景测试（404、400、500）
2. Mock 测试使用 verify(mockRepository, times(1)).delete("1") 验证调用
3. Bug Bash 报告每个 bug 包含：清晰的复现步骤、优先级、修复计划
4. 根因分析需要包含：直接原因、设计缺陷、测试盲区、修复方案
```

---

## 验证命令（助教使用）

```bash
# 验证测试通过
cd /path/to/week_12_submission
mvn test

# 验证 Mockito 配置
grep "mockito" pom.xml

# 检查测试类
ls src/test/java/**/*IntegrationTest.java
ls src/test/java/**/*MockTest.java

# 检查文档
cat BUG_BASH_REPORT.md
cat ROOT_CAUSE_ANALYSIS.md
```

---

## 测试运行验证评分

| 测试类型 | 验证命令 | 预期结果 |
|---------|---------|---------|
| 集成测试 | `mvn test -Dtest=TaskApiIntegrationTest` | 所有测试通过 |
| Mock 测试 | `mvn test -Dtest=TaskServiceMockTest` | 所有测试通过 |
| 覆盖率 | `mvn test jacoco:report` | 覆盖率 >= 70% |

**扣分项**：
- 测试无法运行：-10 分/项
- 测试失败：-5 分/个
- 代码无法编译：-20 分
- 提交延迟（每天）：-5 分
