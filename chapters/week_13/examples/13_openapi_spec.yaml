/*
 * 示例：CampusFlow 任务的 OpenAPI 3.0.1 规范。
 *
 * 运行方式：
 *   1. 使用 Swagger UI 在线编辑器：https://editor.swagger.io/
 *   2. 复制本文件内容到编辑器中查看渲染结果
 *   3. 或使用 Swagger Editor Docker：docker run -p 8080:8080 swaggerapi/swagger-editor
 *
 * 预期输出：
 *   - 可交互的 API 文档页面
 *   - 显示所有任务管理端点、请求/响应格式
 *   - 可直接发送测试请求
 *
 * 文档价值：
 *   1. 前后端契约：定义 API 接口规范
 *   2. 自动生成客户端代码：使用 OpenAPI Generator
 *   3. 可执行文档：通过 Swagger UI 直接测试
 */

openapi: 3.0.3
info:
  title: CampusFlow API
  description: |
    CampusFlow 是校园任务管理系统，支持创建任务、设置截止日期、标记完成。

    **重要约束**：
    - 任务标题最大 100 字符（业务规则）
    - 任务 ID 是 UUID 格式
    - 所有日期时间使用 ISO 8601 格式 (YYYY-MM-DD)
    - 删除任务为软删除，实际保留在数据库中

  version: 1.0.0
  contact:
    name: CampusFlow Team
    email: support@campusflow.example.com
  license:
    name: MIT

servers:
  - url: http://localhost:7070
    description: 本地开发服务器
  - url: https://api.campusflow.example.com
    description: 生产环境

tags:
  - name: 任务管理
    description: 任务的增删改查操作
  - name: 业务功能
    description: 特定业务功能（完成、逾期费等）
  - name: 统计
    description: 统计和查询接口

paths:
  /health:
    get:
      tags: [统计]
      summary: 健康检查
      description: 检查服务是否正常运行
      responses:
        '200':
          description: 服务正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Health'

  /stats:
    get:
      tags: [统计]
      summary: 获取统计信息
      description: 获取任务统计（总数、已完成、逾期等）
      responses:
        '200':
          description: 统计信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Stats'

  /tasks:
    get:
      tags: [任务管理]
      summary: 获取所有任务
      description: |
        返回当前用户的所有任务，按创建时间倒序排列。

        **分页**：支持 `?page=1&size=20` 参数（可选）
        **搜索**：支持 `?keyword=xxx` 参数（可选，在标题和描述中搜索）
      parameters:
        - name: page
          in: query
          description: 页码（从 1 开始，默认 1）
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: size
          in: query
          description: 每页数量（默认 20，最大 100）
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: keyword
          in: query
          description: 搜索关键词（在标题和描述中搜索）
          schema:
            type: string
      responses:
        '200':
          description: 成功返回任务列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [任务管理]
      summary: 创建新任务
      description: |
        创建一个新任务。标题必填，描述和截止日期可选。

        **业务规则**：
        - 标题必填，长度 1-100 字符
        - 如果标题超过 100 字符，返回 400 错误
        - 截止日期必须是未来日期（否则返回 400）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskInput'
            examples:
              minimal:
                summary: 最小请求（仅标题）
                value:
                  title: "完成 Week 13 作业"
              full:
                summary: 完整请求
                value:
                  title: "学习 OpenAPI 规范"
                  description: "编写 CampusFlow 的 API 文档"
                  dueDate: "2026-02-20"
      responses:
        '201':
          description: 任务创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: 请求参数错误（如标题为空、超过长度限制、日期格式错误）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                emptyTitle:
                  summary: 标题为空
                  value:
                    code: 400
                    message: "标题不能为空"
                    timestamp: 1739356800000
                invalidDate:
                  summary: 日期格式错误
                  value:
                    code: 400
                    message: "日期格式错误，应为 YYYY-MM-DD"
                    timestamp: 1739356800000

  /tasks/{id}:
    get:
      tags: [任务管理]
      summary: 获取单个任务
      description: 根据 ID 获取任务详情
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 成功返回任务
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [任务管理]
      summary: 更新任务（完整更新）
      description: |
        完整更新任务的所有字段。未提供的字段会被清空。

        **注意**：如果只需要更新部分字段，建议使用 PATCH 方法。
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskInput'
      responses:
        '200':
          description: 任务更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags: [任务管理]
      summary: 部分更新任务
      description: |
        部分更新任务字段。只更新提供的字段，未提供的字段保持不变。

        **使用场景**：
        - 只更新标题：`{"title": "新标题"}`
        - 只标记完成：`{"completed": true}`
        - 更新多个字段：`{"title": "新标题", "completed": true}`
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  description: 任务标题（1-100 字符）
                  minLength: 1
                  maxLength: 100
                description:
                  type: string
                  description: 任务详细描述
                dueDate:
                  type: string
                  format: date
                  description: 截止日期 (YYYY-MM-DD)
                completed:
                  type: boolean
                  description: 任务是否已完成
              additionalProperties: false
      responses:
        '200':
          description: 任务更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [任务管理]
      summary: 删除任务
      description: |
        删除指定任务。

        **注意**：当前实现为软删除，任务实际保留在数据库中。
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 删除成功（无响应体）
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tasks/{id}/complete:
    post:
      tags: [业务功能]
      summary: 标记任务完成
      description: |
        将任务标记为已完成，并记录完成时间。

        **业务规则**：
        - 如果任务已逾期，会计算逾期天数
        - 重复标记不会报错（幂等操作）
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 任务已标记完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tasks/{id}/overdue-fee:
    get:
      tags: [业务功能]
      summary: 计算逾期费用
      description: |
        计算任务逾期费用（演示业务功能）。

        **业务规则**：
        - 每逾期一天收费 1 元
        - 未完成的任务才会计算
        - 已完成的任务返回 0
      parameters:
        - name: id
          in: path
          required: true
          description: 任务 ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 逾期费用
          content:
            application/json:
              schema:
                type: object
                required: [taskId, overdueDays, fee]
                properties:
                  taskId:
                    type: string
                    format: uuid
                    description: 任务 ID
                  overdueDays:
                    type: integer
                    description: 逾期天数（负数表示未逾期）
                  fee:
                    type: number
                    format: float
                    description: 逾期费用（元）

components:
  schemas:
    Task:
      type: object
      required:
        - id
        - title
        - completed
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: 任务的唯一标识符（UUID）
        title:
          type: string
          description: 任务标题
          minLength: 1
          maxLength: 100
          example: "完成 Week 13 作业"
        description:
          type: string
          nullable: true
          description: 任务详细描述（可选）
          example: "编写 OpenAPI 文档和 README"
        dueDate:
          type: string
          format: date
          nullable: true
          description: 截止日期 (YYYY-MM-DD)
          example: "2026-02-20"
        completed:
          type: boolean
          description: 任务是否已完成
          example: false
        createdAt:
          type: string
          format: date-time
          description: 任务创建时间
          example: "2026-02-12T10:30:00Z"
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: 任务完成时间（仅已完成任务）

    TaskInput:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          description: 任务标题（1-100 字符）
          minLength: 1
          maxLength: 100
          example: "学习 OpenAPI 规范"
        description:
          type: string
          description: 任务详细描述（可选）
          nullable: true
          example: "编写 CampusFlow 的 API 文档"
        dueDate:
          type: string
          format: date
          description: 截止日期 (YYYY-MM-DD，可选)
          nullable: true
          example: "2026-02-20"

    Health:
      type: object
      required: [service, version, status]
      properties:
        service:
          type: string
          example: "CampusFlow"
        version:
          type: string
          example: "2.3.0"
        status:
          type: string
          enum: [UP, DOWN]
          example: "UP"
        features:
          type: object
          properties:
            cors:
              type: string
              example: "enabled"
            quality_gates:
              type: string
              example: "enabled"
            integration_tests:
              type: string
              example: "enabled"

    Stats:
      type: object
      required: [total, completed, pending, overdue]
      properties:
        total:
          type: integer
          description: 任务总数
          example: 10
        completed:
          type: integer
          description: 已完成任务数
          example: 5
        pending:
          type: integer
          description: 进行中任务数
          example: 3
        overdue:
          type: integer
          description: 逾期任务数
          example: 2

    Error:
      type: object
      required: [code, message, timestamp]
      properties:
        code:
          type: integer
          description: HTTP 状态码
          example: 400
        message:
          type: string
          description: 错误信息
          example: "标题不能为空"
        timestamp:
          type: integer
          format: int64
          description: 错误发生时间（Unix 时间戳）
          example: 1739356800000
