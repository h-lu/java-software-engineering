<!--
 * ç¤ºä¾‹ï¼šå®¡æŸ¥ä¿®å¤åçš„å‰ç«¯ä»£ç ï¼ˆå®‰å…¨ã€å¥å£®çš„ç‰ˆæœ¬ï¼‰
 * è¿è¡Œæ–¹å¼ï¼šç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤æ–‡ä»¶ï¼ˆéœ€è¦é…åˆåç«¯æœåŠ¡ï¼‰
 * é¢„æœŸè¾“å‡ºï¼šåŠŸèƒ½å®Œæ•´çš„ä»»åŠ¡ç®¡ç†ç•Œé¢ï¼Œå…·å¤‡å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ
 *
 * æœ¬æ–‡ä»¶ä¿®å¤äº† AI ç”Ÿæˆç‰ˆæœ¬çš„æ‰€æœ‰é—®é¢˜ï¼š
 * 1. ä½¿ç”¨ textContent æ›¿ä»£ innerHTMLï¼ˆXSS é˜²æŠ¤ï¼‰
 * 2. æ·»åŠ  try-catch é”™è¯¯å¤„ç†
 * 3. æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
 * 4. æ·»åŠ ç©ºçŠ¶æ€å‹å¥½æç¤º
 * 5. å®Œæ•´çš„ API è·¯å¾„é…ç½®
 * 6. æ­£ç¡®çš„ Fetch API ä½¿ç”¨æ–¹æ³•
 * 7. æ·»åŠ åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
 * 8. è¡¨å•æäº¤åæ¸…ç©º
 * 9. æŒ‰é’®ç¦ç”¨é˜²æ­¢é‡å¤æäº¤
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusFlow - ä»»åŠ¡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .task-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: background 0.2s;
        }

        .task-item:hover {
            background: #f9f9f9;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .task-info p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .task-date {
            color: #999;
            font-size: 12px;
        }

        .overdue {
            color: #f44336;
            font-weight: bold;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .task-actions button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-delete {
            background: #f44336;
        }

        .btn-delete:hover:not(:disabled) {
            background: #da190b;
        }

        .btn-complete {
            background: #2196F3;
        }

        .btn-complete:hover:not(:disabled) {
            background: #1976D2;
        }

        .completed {
            opacity: 0.6;
        }

        .completed h3 {
            text-decoration: line-through;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 8px;
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
        }

        .error-message button {
            background: transparent;
            color: #c62828;
            padding: 0;
            margin-left: 10px;
            text-decoration: underline;
            font-size: 14px;
        }

        /* æˆåŠŸæç¤ºæ ·å¼ */
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .task-item {
                flex-direction: column;
            }

            .task-actions {
                margin-top: 10px;
                width: 100%;
            }

            .task-actions button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CampusFlow ä»»åŠ¡ç®¡ç†</h1>

        <!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
        <div id="messageContainer"></div>

        <div class="form-section">
            <h2>æ·»åŠ æ–°ä»»åŠ¡</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label for="title">ä»»åŠ¡æ ‡é¢˜ *</label>
                    <input type="text" id="title" name="title" required
                           placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label for="description">ä»»åŠ¡æè¿°</label>
                    <textarea id="description" name="description"
                              placeholder="è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div class="form-group">
                    <label for="dueDate">æˆªæ­¢æ—¥æœŸ *</label>
                    <input type="date" id="dueDate" name="dueDate" required>
                </div>
                <button type="submit" id="submitBtn">æ·»åŠ ä»»åŠ¡</button>
            </form>
        </div>

        <div class="task-list">
            <h2>ä»»åŠ¡åˆ—è¡¨</h2>
            <div id="taskContainer">
                <!-- åˆå§‹æ˜¾ç¤ºåŠ è½½çŠ¶æ€ -->
                <div class="loading">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // é…ç½®
        // ============================================
        const CONFIG = {
            // ä½¿ç”¨å®Œæ•´ URLï¼Œé¿å…è·¨åŸŸé—®é¢˜
            API_BASE_URL: 'http://localhost:7070',
            // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            TIMEOUT: 10000
        };

        // ============================================
        // å·¥å…·å‡½æ•°
        // ============================================

        /**
         * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
         */
        function showError(message, retryCallback) {
            const container = document.getElementById('messageContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;

            if (retryCallback) {
                const retryBtn = document.createElement('button');
                retryBtn.textContent = 'é‡è¯•';
                retryBtn.onclick = () => {
                    errorDiv.remove();
                    retryCallback();
                };
                errorDiv.appendChild(retryBtn);
            }

            container.appendChild(errorDiv);

            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => errorDiv.remove(), 5000);
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
         */
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            container.appendChild(successDiv);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => successDiv.remove(), 3000);
        }

        /**
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         */
        function showLoading(containerId, message = 'åŠ è½½ä¸­...') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="loading">${message}</div>`;
        }

        /**
         * æ˜¾ç¤ºç©ºçŠ¶æ€
         */
        function showEmptyState(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <h3>æš‚æ— ä»»åŠ¡</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ ä»»åŠ¡"åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</p>
                </div>
            `;
        }

        /**
         * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦é€¾æœŸ
         */
        function isOverdue(dueDate, status) {
            if (status === 'completed') return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            return due < today;
        }

        /**
         * è®¡ç®—é€¾æœŸå¤©æ•°
         */
        function getOverdueDays(dueDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            const diffTime = today - due;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        /**
         * åˆ›å»ºå¸¦è¶…æ—¶çš„ fetch
         */
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                throw error;
            }
        }

        // ============================================
        // API è°ƒç”¨å‡½æ•°
        // ============================================

        /**
         * è·å–æ‰€æœ‰ä»»åŠ¡
         */
        async function fetchTasks() {
            const response = await fetchWithTimeout(`${CONFIG.API_BASE_URL}/tasks`);

            if (!response.ok) {
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
            }

            // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ .json() æ–¹æ³•ï¼Œè€Œä¸æ˜¯ .getJSON()
            return await response.json();
        }

        /**
         * åˆ›å»ºä»»åŠ¡
         */
        async function createTask(taskData) {
            const response = await fetchWithTimeout(`${CONFIG.API_BASE_URL}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `åˆ›å»ºå¤±è´¥: ${response.status}`);
            }

            return await response.json();
        }

        /**
         * åˆ é™¤ä»»åŠ¡
         */
        async function deleteTaskApi(id) {
            const response = await fetchWithTimeout(
                `${CONFIG.API_BASE_URL}/tasks/${id}`,
                { method: 'DELETE' }
            );

            if (!response.ok) {
                throw new Error(`åˆ é™¤å¤±è´¥: ${response.status}`);
            }
        }

        /**
         * æ ‡è®°ä»»åŠ¡å®Œæˆ/æœªå®Œæˆ
         */
        async function toggleTaskComplete(id) {
            const response = await fetchWithTimeout(
                `${CONFIG.API_BASE_URL}/tasks/${id}/complete`,
                { method: 'POST' }
            );

            if (!response.ok) {
                throw new Error(`æ“ä½œå¤±è´¥: ${response.status}`);
            }

            return await response.json();
        }

        // ============================================
        // UI æ¸²æŸ“å‡½æ•°
        // ============================================

        /**
         * æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
         * ä¿®å¤ï¼šä½¿ç”¨ createElement æ›¿ä»£ innerHTMLï¼Œé˜²æ­¢ XSS
         */
        function renderTasks(tasks) {
            const container = document.getElementById('taskContainer');

            // å¤„ç†ç©ºçŠ¶æ€
            if (!tasks || tasks.length === 0) {
                showEmptyState('taskContainer');
                return;
            }

            container.innerHTML = '';

            tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${task.status === 'completed' ? 'completed' : ''}`;

                // å®‰å…¨åœ°åˆ›å»ºä»»åŠ¡ä¿¡æ¯åŒºåŸŸ
                const infoDiv = document.createElement('div');
                infoDiv.className = 'task-info';

                // ä½¿ç”¨ textContent å®‰å…¨åœ°æ’å…¥æ–‡æœ¬ï¼Œé˜²æ­¢ XSS
                const title = document.createElement('h3');
                title.textContent = task.title;  // å®‰å…¨ï¼šè‡ªåŠ¨è½¬ä¹‰ HTML
                infoDiv.appendChild(title);

                if (task.description) {
                    const desc = document.createElement('p');
                    desc.textContent = task.description;  // å®‰å…¨ï¼šè‡ªåŠ¨è½¬ä¹‰ HTML
                    infoDiv.appendChild(desc);
                }

                const dateDiv = document.createElement('div');
                dateDiv.className = 'task-date';

                // æ£€æŸ¥æ˜¯å¦é€¾æœŸ
                if (isOverdue(task.dueDate, task.status)) {
                    const overdueDays = getOverdueDays(task.dueDate);
                    dateDiv.innerHTML = `æˆªæ­¢æ—¥æœŸ: ${task.dueDate} `;
                    const overdueSpan = document.createElement('span');
                    overdueSpan.className = 'overdue';
                    overdueSpan.textContent = `(å·²é€¾æœŸ ${overdueDays} å¤©)`;
                    dateDiv.appendChild(overdueSpan);
                } else {
                    dateDiv.textContent = `æˆªæ­¢æ—¥æœŸ: ${task.dueDate}`;
                }
                infoDiv.appendChild(dateDiv);

                taskDiv.appendChild(infoDiv);

                // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';

                const completeBtn = document.createElement('button');
                completeBtn.className = 'btn-complete';
                completeBtn.textContent = task.status === 'completed' ? 'æ ‡è®°æœªå®Œæˆ' : 'æ ‡è®°å®Œæˆ';
                completeBtn.onclick = () => handleToggleComplete(task.id);
                actionsDiv.appendChild(completeBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = () => handleDeleteTask(task.id, task.title);
                actionsDiv.appendChild(deleteBtn);

                taskDiv.appendChild(actionsDiv);
                container.appendChild(taskDiv);
            });
        }

        // ============================================
        // äº‹ä»¶å¤„ç†å‡½æ•°
        // ============================================

        /**
         * åŠ è½½ä»»åŠ¡åˆ—è¡¨
         */
        async function loadTasks() {
            showLoading('taskContainer', 'æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...');

            try {
                const result = await fetchTasks();
                // API è¿”å›æ ¼å¼: { data: [], total: n }
                renderTasks(result.data || result);
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showError(`åŠ è½½ä»»åŠ¡å¤±è´¥: ${error.message}`, loadTasks);
            }
        }

        /**
         * å¤„ç†è¡¨å•æäº¤
         */
        async function handleSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æ·»åŠ ä¸­...';

            try {
                const formData = {
                    title: document.getElementById('title').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    dueDate: document.getElementById('dueDate').value
                };

                // å®¢æˆ·ç«¯éªŒè¯
                if (!formData.title) {
                    throw new Error('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                }

                if (!formData.dueDate) {
                    throw new Error('è¯·é€‰æ‹©æˆªæ­¢æ—¥æœŸ');
                }

                await createTask(formData);

                // æ¸…ç©ºè¡¨å•
                document.getElementById('taskForm').reset();
                showSuccess('ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');

                // åˆ·æ–°åˆ—è¡¨
                await loadTasks();
            } catch (error) {
                console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥:', error);
                showError(`æ·»åŠ å¤±è´¥: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æ·»åŠ ä»»åŠ¡';
            }
        }

        /**
         * å¤„ç†åˆ é™¤ä»»åŠ¡
         */
        async function handleDeleteTask(id, title) {
            // æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                await deleteTaskApi(id);
                showSuccess('ä»»åŠ¡å·²åˆ é™¤');
                await loadTasks();
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                showError(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        /**
         * å¤„ç†æ ‡è®°å®Œæˆ/æœªå®Œæˆ
         */
        async function handleToggleComplete(id) {
            try {
                await toggleTaskComplete(id);
                await loadTasks();
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                showError(`æ“ä½œå¤±è´¥: ${error.message}`);
            }
        }

        // ============================================
        // åˆå§‹åŒ–
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('taskForm').addEventListener('submit', handleSubmit);

            // åŠ è½½åˆå§‹æ•°æ®
            loadTasks();
        });
    </script>
</body>
</html>
